<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> - GymManagement</title>
    <link rel="stylesheet" href="styles.css">
    <script defer src="scripts.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><span>GymManagement</span></h2>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active" data-page="dashboard">
                    <span>Dashboard</span>
                </li>
                <li class="nav-item" data-page="clients">
                    <span>Clientes</span>
                </li>
                <li class="nav-item" data-page="memberships">
                    <span>Membres√≠as</span>
                </li>
                <li class="nav-item" data-page="attendance">
                    <span>Asistencia</span>
                </li>
                <li class="nav-item" data-page="payments">
                    <span>Pagos</span>
                </li>
                <li class="nav-item" data-page="trainers">
                    <span>Entrenadores</span>
                </li>
                <li class="nav-item" data-page="reports">
                    <span>Reportes</span>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <h2 id="page-title">Dashboard</h2>
                <div class="user-info">
                    <div class="user-avatar">A</div>
                    <div>
                        <div>Administrador</div>
                        <small>admin@GymManagement</small>
                    </div>
                </div>
            </div>

            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page">
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-card-title">Clientes Activos</div>
                                <small class="stat-card-subtitle">Total de clientes con membres√≠a activa</small>
                            </div>
                            <div class="icon" style="background-color: var(--primary);">üë§</div>
                        </div>
                        <div class="stat-card-value" id="active-clients-count">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-card-title">Asistencias Hoy</div>
                                <small class="stat-card-subtitle">Visitas registradas hoy</small>
                            </div>
                            <div class="icon" style="background-color: var(--success);">üìù</div>
                        </div>
                        <div class="stat-card-value" id="today-attendance-count">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-card-title">Entrenadores</div>
                                <small class="stat-card-subtitle">Total de entrenadores</small>
                            </div>
                            <div class="icon" style="background-color: var(--warning);">üë®‚Äçüè´</div>
                        </div>
                        <div class="stat-card-value" id="trainers-count">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-card-title">Ingresos Mensuales</div>
                                <small class="stat-card-subtitle">Total en el mes actual</small>
                            </div>
                            <div class="icon" style="background-color: var(--success);">üí∞</div>
                        </div>
                        <div class="stat-card-value" id="monthly-income">$0</div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="mb-4">Membres√≠as a Vencer Esta Semana</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>C√©dula</th>
                                <th>Cliente</th>
                                <th>Tipo de Membres√≠a</th>
                                <th>Fecha de Vencimiento</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="expiring-memberships">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <div class="card">
                    <h3 class="mb-4">√öltimas Asistencias</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>C√©dula</th>
                                <th>Cliente</th>
                                <th>Fecha y Hora</th>
                                <th>Entrenador</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="recent-attendance">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Modal para detalles (a√±adir si no existe) -->
<div class="modal fade" id="attendance-details-modal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Se llenar√° din√°micamente -->
        </div>
    </div>
</div>
            <!-- Clients Page -->
            <div id="clients-page" class="page" style="display: none;">
                <div class="d-flex justify-between align-center mb-4">
                    <h3>Gesti√≥n de Clientes</h3>
                    <button class="btn btn-primary" id="add-client-btn">+ Agregar Cliente</button>
                </div>

                <div class="card">
                    <div class="search-bar">
                        <div class="d-flex gap-2">
                            <div class="form-group" style="flex: 1;">
                                <input type="text" class="form-control" id="search-client" 
                                    placeholder="Buscar por nombre, correo o tel√©fono...">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <input type="text" class="form-control" id="search-client-cedula" 
                                    placeholder="Buscar por c√©dula..." maxlength="11">
                            </div>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>C√©dula</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Tel√©fono</th>
                                <th>Membres√≠a</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clients-table">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Memberships Page -->
            <div id="memberships-page" class="page" style="display: none;">
                <div class="d-flex justify-between align-center mb-4">
                    <h3>Gesti√≥n de Membres√≠as</h3>
                    <button class="btn btn-primary" id="add-membership-btn">+ Agregar Membres√≠a</button>
                </div>

                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Id</th>
                                <th>Nombre</th>
                                <th>Descripci√≥n</th>
                                <th>Duraci√≥n</th>
                                <th>Precio</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="memberships-table">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Attendance Page -->
            <div id="attendance-page" class="page" style="display: none;">
                <div class="d-flex justify-between align-center mb-4">
                    <h3>Registro de Asistencia</h3>
                    <button class="btn btn-primary" id="add-attendance-btn">+ Registrar Asistencia</button>
                </div>

                <div class="card">
                    <div class="d-flex gap-2 mb-4">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Fecha Desde</label>
                            <input type="date" class="form-control" id="attendance-date-from">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Fecha Hasta</label>
                            <input type="date" class="form-control" id="attendance-date-to">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Cliente</label>
                            <select class="form-control" id="attendance-client-filter">
                                <option value="">Todos los clientes</option>
                                <!-- Clients will be loaded here -->
                            </select>
                        </div>
                        <div class="form-group d-flex align-center">
                            <button class="btn btn-primary" id="filter-attendance-btn" style="margin-top: 25px;">Filtrar</button>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>C√©dula</th>
                                <th>Cliente</th>
                                <th>Fecha y Hora</th>
                                <th>Entrenador</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Payments Page -->
            <div id="payments-page" class="page" style="display: none;">
                <div class="d-flex justify-between align-center mb-4">
                    <h3>Gesti√≥n de Pagos</h3>
                    <button class="btn btn-primary" id="add-payment-btn">+ Registrar Pago</button>
                </div>

                <div class="card">
                    <div class="d-flex gap-2 mb-4">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Fecha Desde</label>
                            <input type="date" class="form-control" id="payment-date-from">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Fecha Hasta</label>
                            <input type="date" class="form-control" id="payment-date-to">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Estado</label>
                            <select class="form-control" id="payment-status-filter">
                                <option value="">Todos los estados</option>
                                <option value="Pagado">Pagado</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="Reembolsado">Reembolsado</option>
                            </select>
                        </div>
                        <div class="form-group d-flex align-center">
                            <button class="btn btn-primary" id="filter-payments-btn" style="margin-top: 25px;">Filtrar</button>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>C√©dula</th>
                                <th>Cliente</th>
                                <th>Membres√≠a</th>
                                <th>Monto</th>
                                <th>M√©todo</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="payments-table">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Trainers Page -->
            <div id="trainers-page" class="page" style="display: none;">
                <div class="d-flex justify-between align-center mb-4">
                    <h3>Gesti√≥n de Entrenadores</h3>
                    <button class="btn btn-primary" id="add-trainer-btn">+ Agregar Entrenador</button>
                </div>

                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>C√©dula</th>
                                <th>Nombre</th>
                                <th>Especialidad</th>
                                <th>Email</th>
                                <th>Tel√©fono</th>
                                <th>Clientes Asignados</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="trainers-table">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Page -->
            <div id="reports-page" class="page" style="display: none;">
                <h3 class="mb-4">Reportes y Estad√≠sticas</h3>

                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-btn active" data-tab="income-report">Reporte de Ingresos</button>
                        <button class="tab-btn" data-tab="attendance-report">Historial de Asistencia</button>
                        <button class="tab-btn" data-tab="membership-report">Estado de Membres√≠as</button>
                        <button class="tab-btn" data-tab="trainer-report">Reporte de Entrenadores</button>
                    </div>

                    <!-- Income Report Tab -->
                    <div class="tab-content active" id="income-report">
                        <div class="card">
                            <div class="d-flex gap-2 mb-4">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Rango de Fechas</label>
                                    <select class="form-control" id="income-date-range">
                                        <option value="day">D√≠a</option>
                                        <option value="week">Semana</option>
                                        <option value="month" selected>Mes</option>
                                        <option value="year">A√±o</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Tipo de Membres√≠a</label>
                                    <select class="form-control" id="income-membership-type">
                                        <option value="">Todas las membres√≠as</option>
                                        <!-- Memberships will be loaded here -->
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">M√©todo de Pago</label>
                                    <select class="form-control" id="income-payment-method">
                                        <option value="">Todos los m√©todos</option>
                                        <option value="Tarjeta">Tarjeta</option>
                                        <option value="Efectivo">Efectivo</option>
                                        <option value="Transferencia">Transferencia</option>
                                    </select>
                                </div>
                                <div class="form-group d-flex align-center">
                                    <button class="btn btn-primary" id="generate-income-report" style="margin-top: 25px;">Generar</button>
                                </div>
                            </div>

                            <table>
                                <thead>
                                    <tr>
                                        <th>C√©dula</th>
                                        <th>Fecha</th>
                                        <th>Cliente</th>
                                        <th>Membres√≠a</th>
                                        <th>Monto (USD)</th>
                                        <th>Descuento(%)</th>
                                        <th>Monto Final</th>
                                        <th>M√©todo de pago</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="income-report-table">
                                    <!-- Data will be loaded here -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="4" style="text-align: right;"><strong>Total:</strong></td>
                                        <td id="income-total" colspan="5"><strong>$0</strong></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- Attendance Report Tab -->
                    <div class="tab-content" id="attendance-report">
                        <div class="card">
                            <div class="d-flex gap-2 mb-4">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Cliente</label>
                                    <select class="form-control" id="attendance-report-client">
                                        <option value="">Todos los clientes</option>
                                        <!-- Clients will be loaded here -->
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Fecha Desde</label>
                                    <input type="date" class="form-control" id="attendance-report-date-from">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Fecha Hasta</label>
                                    <input type="date" class="form-control" id="attendance-report-date-to">
                                </div>
                                <div class="form-group d-flex align-center">
                                    <button class="btn btn-primary" id="generate-attendance-report" style="margin-top: 25px;">Generar</button>
                                </div>
                            </div>

                            <table>
                                <thead>
                                    <tr>
                                        <th>ID Asistencia</th>
                                        <th>Fecha y hora</th>
                                        <th>Cliente</th>
                                        <th>Entrenador Asignado</th>
                                        <th>Tipo de Membres√≠a</th>
                                        <th>Estado de visita</th>
                                    </tr>
                                </thead>
                                <tbody id="attendance-report-table">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Membership Report Tab -->
                    <div class="tab-content" id="membership-report">
                        <div class="card">
                            <div class="d-flex gap-2 mb-4">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Estado</label>
                                    <select class="form-control" id="membership-report-status">
                                        <option value="">Todos los estados</option>
                                        <option value="Activo">Activo</option>
                                        <option value="Inactivo">Inactivo</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Tipo de Membres√≠a</label>
                                    <select class="form-control" id="membership-report-type">
                                        <option value="">Todos los tipos</option>
                                        <!-- Memberships will be loaded here -->
                                    </select>
                                </div>
                                <div class="form-group d-flex align-center">
                                    <button class="btn btn-primary" id="generate-membership-report" style="margin-top: 25px;">Generar</button>
                                </div>
                            </div>

                            <table>
                                <thead>
                                    <tr>
                                        <th>ID Cliente</th>
                                        <th>Nombre</th>
                                        <th>Tipo de membres√≠a</th>
                                        <th>Fecha de inicio</th>
                                        <th>Estado</th>
                                        <th>Ultima visita</th>
                                    </tr>
                                </thead>
                                <tbody id="membership-report-table">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Trainer Report Tab -->
                    <div class="tab-content" id="trainer-report">
                        <div class="card">
                            <div class="d-flex gap-2 mb-4">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Entrenador</label>
                                    <select class="form-control" id="trainer-report-trainer">
                                        <option value="">Todos los entrenadores</option>
                                        <!-- Trainers will be loaded here -->
                                    </select>
                                </div>
                                <div class="form-group d-flex align-center">
                                    <button class="btn btn-primary" id="generate-trainer-report" style="margin-top: 25px;">Generar</button>
                                </div>
                            </div>

                            <table>
                                <thead>
                                    <tr>
                                        <th>ID Entrenador</th>
                                        <th>Nombre</th>
                                        <th>Clientes Asignados</th>
                                        <th>Sesiones Realizadas</th>
                                        <th>√öltima Sesi√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="trainer-report-table">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Client Modal -->
    <div class="modal" id="client-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="client-modal-title">Agregar Cliente</h3>
                <button class="modal-close" data-close="client-modal">&times;</button>
            </div>
            <div id="client-form-alert" class="alert hidden"></div>
            <form id="client-form">
                <div class="form-group">
                    <label class="form-label" for="client-cedula">C√©dula</label>
                    <input type="text" class="form-control" id="client-cedula" maxlength="11" pattern="[0-9]*" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="client-phone">Tel√©fono</label>
                    <input type="tel" class="form-control" id="client-phone" maxlength="10" pattern="[0-9]*" required>
                </div>              
                <div class="form-group">
                    <label class="form-label" for="client-name">Nombre</label>
                    <input type="text" class="form-control" id="client-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="client-email">Correo electr√≥nico</label>
                    <input type="email" class="form-control" id="client-email" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="client-phone">Tel√©fono</label>
                    <input type="tel" class="form-control" id="client-phone" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="client-birthdate">Fecha de Nacimiento</label>
                    <input type="date" class="form-control" id="client-birthdate">
                </div>
                <div class="form-group">
                    <label class="form-label" for="client-gender">G√©nero</label>
                    <select class="form-control" id="client-gender">
                        <option value="M">Masculino</option>
                        <option value="F">Femenino</option>
                        <option value="O">Otro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="client-membership">Membres√≠a</label>
                    <select class="form-control" id="client-membership" required>
                        <option value="">Seleccionar membres√≠a</option>
                        <!-- Memberships will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="client-start-date">Fecha de inicio</label>
                    <input type="date" class="form-control" id="client-start-date" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Membership Modal -->
    <div class="modal" id="membership-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="membership-modal-title">Agregar Membres√≠a</h3>
                <button class="modal-close" data-close="membership-modal">&times;</button>
            </div>
            <div id="membership-form-alert" class="alert hidden"></div>
            <form id="membership-form">
                <input type="hidden" id="membership-id">
                <div class="form-group">
                    <label class="form-label" for="membership-name">Nombre</label>
                    <input type="text" class="form-control" id="membership-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="membership-description">Descripci√≥n</label>
                    <textarea class="form-control" id="membership-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="membership-duration">Duraci√≥n</label>
                    <select class="form-control" id="membership-duration" required>
                        <option value="mensual">Mensual</option>
                        <option value="trimestral">Trimestral</option>
                        <option value="semestral">Semestral</option>
                        <option value="anual">Anual</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="membership-price">Precio</label>
                    <input type="number" class="form-control" id="membership-price" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Attendance Modal -->
    <div class="modal" id="attendance-modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="attendance-modal-title">Registrar Asistencia</h3>
            <button class="modal-close" data-close="attendance-modal">&times;</button>
          </div>
          <div id="attendance-form-alert" class="alert hidden"></div>
          <form id="attendance-form">
            <input type="hidden" id="attendance-id">
            
            <!-- Select de Cliente -->
            <div class="form-group">
              <label class="form-label" for="attendance-client">c√©dula</label>
              <select class="form-control" id="attendance-client" required>
                <option value="">Seleccionar c√©dula</option>
                <!-- Se cargar√°n los clientes aqu√≠ -->
              </select>
            </div>
            
            <!-- Nuevo campo para mostrar el Nombre del Cliente (readonly) -->
            <div class="form-group">
              <label class="form-label" for="attendance-client-name">Nombre del Cliente</label>
              <input type="text" class="form-control" id="attendance-client-name" readonly>
            </div>
            
            <!-- Fecha y Hora -->
            <div class="form-group">
              <label class="form-label" for="attendance-date">Fecha</label>
              <input type="date" class="form-control" id="attendance-date" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="attendance-time">Hora</label>
              <input type="time" class="form-control" id="attendance-time" required>
            </div>
            <!-- Otros campos: Entrenador y Estado -->
            <div class="form-group">
              <label class="form-label" for="attendance-trainer">Entrenador Asignado</label>
              <select class="form-control" id="attendance-trainer">
                <option value="">Ninguno</option>
                <!-- Se cargar√°n los entrenadores aqu√≠ -->
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="attendance-status">Estado</label>
              <select class="form-control" id="attendance-status" required>
                <option value="Confirmada">Confirmada</option>
                <option value="Cancelada">Cancelada</option>
              </select>
            </div>
            <div class="form-group">
              <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
          </form>
        </div>
      </div>

    <!-- Payment Modal -->
    <div class="modal" id="payment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="payment-modal-title">Registrar Pago</h3>
                <button class="modal-close" data-close="payment-modal">&times;</button>
            </div>
            <div id="payment-form-alert" class="alert hidden"></div>
            <form id="payment-form">
                <input type="hidden" id="payment-id">
                <div class="form-group">
                    <label class="form-label" for="payment-client">Cedula</label>
                    <select class="form-control" id="payment-client" required>
                        <option value="">Seleccionar cliente</option>
                        <!-- Clients will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="payment-client-name">Nombre del Cliente</label>
                    <input type="text" class="form-control" id="payment-client-name" readonly>
                  </div>                  
                <div class="form-group">
                    <label class="form-label" for="payment-membership">Membres√≠a</label>
                    <select class="form-control" id="payment-membership" required>
                        <option value="">Seleccionar membres√≠a</option>
                        <!-- Memberships will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="payment-amount">Monto</label>
                    <input type="number" class="form-control" id="payment-amount" required min="0" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label" for="payment-discount">Descuento (%)</label>
                    <input type="number" class="form-control" id="payment-discount" min="0" max="100" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label" for="payment-method">M√©todo de Pago</label>
                    <select class="form-control" id="payment-method" required>
                        <option value="Tarjeta">Tarjeta</option>
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="payment-status">Estado</label>
                    <select class="form-control" id="payment-status" required>
                        <option value="Pagado">Pagado</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Reembolsado">Reembolsado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="payment-date">Fecha</label>
                    <input type="date" class="form-control" id="payment-date" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Trainer Modal -->
    <div class="modal" id="trainer-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="trainer-modal-title">Agregar Entrenador</h3>
                <button class="modal-close" data-close="trainer-modal">&times;</button>
            </div>
            <div id="trainer-form-alert" class="alert hidden"></div>
            <form id="trainer-form">
                <input type="hidden" id="trainer-id">
                <div class="form-group">
                    <label class="form-label" for="trainer-name">Nombre</label>
                    <input type="text" class="form-control" id="trainer-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="trainer-specialty">Especialidad</label>
                    <select class="form-control" id="trainer-specialty" required>
                        <option value="">Seleccionar especialidad</option>
                        <option value="Cardio">Cardio</option>
                        <option value="Zumba">Zumba</option>
                        <option value="Pesas">Pesas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="trainer-email">Correo electr√≥nico</label>
                    <input type="email" class="form-control" id="trainer-email" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="trainer-phone">Tel√©fono</label>
                    <input type="tel" class="form-control" id="trainer-phone" maxlength="10" pattern="[0-9]*" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="trainer-schedule">Horario</label>
                    <input type="text" class="form-control" id="trainer-schedule" placeholder="Ej: Lunes a Viernes, 8am - 4pm">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Client View Modal -->
    <div class="modal" id="client-view-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="client-view-name">Detalles de Cliente</h3>
                <button class="modal-close" data-close="client-view-modal">&times;</button>
            </div>
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="client-details">Informaci√≥n</button>
                    <button class="tab-btn" data-tab="client-attendance">Asistencia</button>
                    <button class="tab-btn" data-tab="client-payments">Pagos</button>
                </div>
                <div class="tab-content active" id="client-details">
                    <div class="grid-2">
                        <div>
                            <p><strong>Cedula:</strong> <span id="view-client-id"></span></p>
                            <p><strong>Nombre:</strong> <span id="view-client-name"></span></p>
                            <p><strong>Email:</strong> <span id="view-client-email"></span></p>
                            <p><strong>Tel√©fono:</strong> <span id="view-client-phone"></span></p>
                            <p><strong>Fecha de Nacimiento:</strong> <span id="view-client-birthdate"></span></p>
                        </div>
                        <div>
                            <p><strong>G√©nero:</strong> <span id="view-client-gender"></span></p>
                            <p><strong>Membres√≠a:</strong> <span id="view-client-membership"></span></p>
                            <p><strong>Fecha de Inicio:</strong> <span id="view-client-start-date"></span></p>
                            <p><strong>Fecha de Vencimiento:</strong> <span id="view-client-end-date"></span></p>
                            <p><strong>Estado:</strong> <span id="view-client-status"></span></p>
                        </div>
                    </div>
                </div>
                <div class="tab-content" id="client-attendance">
                    <table>
                        <thead>
                            <tr>
                                <th>Cedula</th>
                                <th>Fecha y Hora</th>
                                <th>Entrenador</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="client-attendance-table">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="tab-content" id="client-payments">
                    <table>
                        <thead>
                            <tr>
                                <th>Cedula</th>
                                <th>Fecha</th>
                                <th>Membres√≠a</th>
                                <th>Monto</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="client-payments-table">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize data storage
// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    // Check if local storage has data, otherwise initialize with demo data
    if (!localStorage.getItem('gymData')) {
        initializeLocalStorage(); //
    }
    // Load data into all tables and selects
    loadClientsTable();
    loadMembershipsTable();
    loadAttendanceTable();
    loadExpiringMemberships();
    loadPaymentMembershipSelect();
    loadPaymentsTable();
    loadTrainersTable();
    loadRecentAttendance();
    
    // Load all select elements
    loadClientSelect();
    loadClientMembershipSelect();
    loadTrainerSelect();
    loadMembershipTypeSelect();
    updateDashboardStats();
    // Show dashboard tab by default
    const dashboardTab = document.querySelector('.tab-btn[data-tab="dashboard"]');
    if (dashboardTab) {
        dashboardTab.click();
    }
    
});


function initializeLocalStorage() {
    // Check if we already have data in localStorage
    if (!localStorage.getItem('gymData')) {
        // Create initial data structure
        const initialData = {
            clients: [{
                id: 1,
                cedula: "123456789",
                name: "Cliente Demo",
                email: "cliente@demo.com",
                phone: "1234567890",
                membership_id: 1,
                start_date: "2025-01-01"
            }],
                    trainers: [],
                    memberships: [
                        {
                            id: 1,
                            name: 'B√°sica Mensual',
                            description: 'Acceso a todas las instalaciones en horario regular',
                            duration: 'mensual',
                            price: 30
                        },
                        {
                            id: 2,
                            name: 'Premium Trimestral',
                            description: 'Acceso ilimitado a todas las instalaciones y clases grupales',
                            duration: 'trimestral',
                            price: 75
                        },
                        {
                            id: 3,
                            name: 'Gold Anual',
                            description: 'Acceso VIP con entrenador personal y nutricionista',
                            duration: 'anual',
                            price: 300
                        }
                    ],
                    attendance: [],
                    payments: [],
                    counters: {
                        clients: 0,
                        trainers: 0,
                        attendance: 0,
                        payments: 0
                    }
                };
                
                // Save to localStorage
                localStorage.setItem('gymData', JSON.stringify(initialData));
            }
        }

        function getGymData() {
    const data = JSON.parse(localStorage.getItem('gymData'));
    
    // Verificar que `data` existe y tiene la estructura correcta
    if (!data || typeof data !== 'object') {
        console.error("Error: gymData no est√° definido o tiene un formato incorrecto.");
        return {
            clients: [],
            trainers: [],
            memberships: [],
            attendance: [],
            payments: [],
            counters: { clients: 0, trainers: 0, attendance: 0, payments: 0 }
        };
    }
    if (!Array.isArray(data.payments)) {
        console.warn("Advertencia: `payments` no es un array. Se inicializa vac√≠o.");
        data.payments = [];
        saveGymData(data);
    }

    return data;
}
function generateId(entity) {
    const data = getGymData();
    
    if (!data.counters[entity]) {
        console.warn(`Advertencia: Contador para '${entity}' no encontrado, inicializando en 1.`);
        data.counters[entity] = 1;
    } else {
        data.counters[entity]++;
    }

    saveGymData(data);
    return data.counters[entity];
}
function saveGymData(data) {
    localStorage.setItem('gymData', JSON.stringify(data));
}

        // Save data to localStorage
        function saveGymData(data) {
            localStorage.setItem('gymData', JSON.stringify(data));
        }

        // Generate unique ID for different entities
        function generateId(entity) {
        const data = getGymData();
        if (!data.counters[entity]) {
        data.counters[entity] = 1; // Inicializa si no existe
        } else {
        data.counters[entity]++;
        }
        saveGymData(data);
        return data.counters[entity];
}

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        // Format date and time for display
        function formatDateTime(dateString, timeString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (timeString) {
                const [hours, minutes] = timeString.split(':');
                date.setHours(hours, minutes);
            }
            return date.toLocaleString();
        }

        // Calculate membership end date
        function calculateEndDate(startDate, duration) {
            const date = new Date(startDate);
            
            switch(duration) {
                case 'mensual':
                    date.setMonth(date.getMonth() + 1);
                    break;
                case 'trimestral':
                    date.setMonth(date.getMonth() + 3);
                    break;
                case 'semestral':
                    date.setMonth(date.getMonth() + 6);
                    break;
                case 'anual':
                    date.setFullYear(date.getFullYear() + 1);
                    break;
            }
            
            return date.toISOString().split('T')[0];
        }

        // Check if a membership is active
        function isMembershipActive(startDate, duration) {
            const endDate = new Date(calculateEndDate(startDate, duration));
            return new Date() <= endDate;
        }

        // Get client by ID
        function getClientByCedula(cedula) {
    const data = getGymData();
    
    if (!cedula && cedula !== 0) return null;

    // Aseg√∫rate de que la c√©dula se compara correctamente (puede ser string vs number)
    return data.clients.find(client => client.cedula.toString() === cedula.toString());
}
        // Get membership by ID
        function getMembershipById(id) {
            const data = getGymData();
            return data.memberships.find(membership => membership.id === parseInt(id));
        }

        // Get trainer by ID
        function getTrainerById(id) {
            const data = getGymData();
            return data.trainers.find(trainer => trainer.id === parseInt(id));
        }

        // Load data into client membership select
        function loadClientMembershipSelect() {
            const data = getGymData();
            const selectElement = document.getElementById('client-membership');
            selectElement.innerHTML = '<option value="">Seleccionar membres√≠a</option>';
            
            data.memberships.forEach(membership => {
                const option = document.createElement('option');
                option.value = membership.id;
                option.textContent = `${membership.name} (${membership.duration})`;
                selectElement.appendChild(option);
            });
        }
        function loadPaymentMembershipSelect() {
    const data = getGymData();
    const selectElement = document.getElementById('payment-membership');
    selectElement.innerHTML = '<option value="">Seleccionar membres√≠a</option>';
    
    data.memberships.forEach(membership => {
        const option = document.createElement('option');
        option.value = membership.id;
        option.textContent = `${membership.name} ($${membership.price})`;
        selectElement.appendChild(option);
    });
}
        // Load data into payment membership select
        function loadPaymentMembershipSelect() {
            const data = getGymData();
            const selectElement = document.getElementById('payment-membership');
            selectElement.innerHTML = '<option value="">Seleccionar membres√≠a</option>';
            
            data.memberships.forEach(membership => {
                const option = document.createElement('option');
                option.value = membership.id;
                option.textContent = `${membership.name} (${membership.price}$)`;
                selectElement.appendChild(option);
            });
        }

        // Autocompletar monto seg√∫n membres√≠a seleccionada
document.getElementById('payment-membership').addEventListener('change', function () {
    const membershipId = parseInt(this.value);
    const membership = getMembershipById(membershipId);

    if (membership) {
        document.getElementById('payment-amount').value = membership.price;
    } else {
        document.getElementById('payment-amount').value = '';
    }
});

        // Load data into client select
        function loadClientSelect() {
            const data = getGymData();
            const attendanceClientSelect = document.getElementById('attendance-client');
            const paymentClientSelect = document.getElementById('payment-client');
            const attendanceFilterSelect = document.getElementById('attendance-client-filter');
            const attendanceReportSelect = document.getElementById('attendance-report-client');
            
            // Clear previous options
            attendanceClientSelect.innerHTML = '<option value="">Seleccionar cliente</option>';
            paymentClientSelect.innerHTML = '<option value="">Seleccionar cliente</option>';
            attendanceFilterSelect.innerHTML = '<option value="">Todos los clientes</option>';
            attendanceReportSelect.innerHTML = '<option value="">Todos los clientes</option>';
            
            // Add active clients
            data.clients.filter(client => {
                const membership = getMembershipById(client.membership_id);
                return isMembershipActive(client.start_date, membership.duration);
            }).forEach(client => {
                // For attendance client select
                const option1 = document.createElement('option');
                option1.value = client.cedula;
                option1.textContent = client.cedula;
                attendanceClientSelect.appendChild(option1);
                
                // For payment client select
                const option2 = document.createElement('option');
                option2.value = client.cedula;
                option2.textContent = client.cedula;
                paymentClientSelect.appendChild(option2);
                
                // For attendance filter select
                const option3 = document.createElement('option');
                option3.value = client.id;
                option3.textContent = client.name;
                attendanceFilterSelect.appendChild(option3);
                
                // For attendance report select
                const option4 = document.createElement('option');
                option4.value = client.id;
                option4.textContent = client.name;
                attendanceReportSelect.appendChild(option4);
            });
        }

        // Mostrar c√©dula y nombre del cliente seleccionado en el modal de pago
document.getElementById('payment-client').addEventListener('change', function () {
    const cedula = this.value;
    const client = getClientByCedula(cedula);
    
    if (client) {
        document.getElementById('payment-client-name').value = client.name;
        // Si quieres mostrar tambi√©n la c√©dula en un campo oculto o de solo lectura:
        // document.getElementById('payment-client-cedula').value = client.cedula;
    } else {
        document.getElementById('payment-client-name').value = '';
        // document.getElementById('payment-client-cedula').value = '';
    }
});

        document.getElementById('client-cedula').addEventListener('input', function(e) {
    // Elimina cualquier car√°cter que no sea n√∫mero
    this.value = this.value.replace(/[^0-9]/g, '');
    
    // Limita a 11 caracteres (por si acaso)
    if (this.value.length > 11) {
        this.value = this.value.slice(0, 11);
    }
});

        // Load data into trainer select
        function loadTrainerSelect() {
            const data = getGymData();
            const attendanceTrainerSelect = document.getElementById('attendance-trainer');
            const trainerReportSelect = document.getElementById('trainer-report-trainer');
            
            // Clear previous options
            attendanceTrainerSelect.innerHTML = '<option value="">Ninguno</option>';
            trainerReportSelect.innerHTML = '<option value="">Todos los entrenadores</option>';
            
            data.trainers.forEach(trainer => {
                // For attendance trainer select
                const option1 = document.createElement('option');
                option1.value = trainer.id;
                option1.textContent = trainer.name;
                attendanceTrainerSelect.appendChild(option1);
                
                // For trainer report select
                const option2 = document.createElement('option');
                option2.value = trainer.id;
                option2.textContent = trainer.name;
                trainerReportSelect.appendChild(option2);
            });
        }

        // Load data into membership type select for reports
        function loadMembershipTypeSelect() {
            const data = getGymData();
            const incomeSelect = document.getElementById('income-membership-type');
            const membershipReportSelect = document.getElementById('membership-report-type');
            
            // Clear previous options
            incomeSelect.innerHTML = '<option value="">Todas las membres√≠as</option>';
            membershipReportSelect.innerHTML = '<option value="">Todos los tipos</option>';
            
            data.memberships.forEach(membership => {
                // For income report select
                const option1 = document.createElement('option');
                option1.value = membership.id;
                option1.textContent = membership.name;
                incomeSelect.appendChild(option1);
                
                // For membership report select
                const option2 = document.createElement('option');
                option2.value = membership.id;
                option2.textContent = membership.name;
                membershipReportSelect.appendChild(option2);
            });
        }

        // Load clients table
        function loadClientsTable() {
            const data = getGymData();
            const tableBody = document.getElementById('clients-table');
            tableBody.innerHTML = '';
            
            data.clients.forEach(client => {
                const membership = getMembershipById(client.membership_id);
                const endDate = calculateEndDate(client.start_date, membership.duration);
                const isActive = isMembershipActive(client.start_date, membership.duration);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${client.cedula}</td>
                    <td>${client.name}</td>
                    <td>${client.email}</td>
                    <td>${client.phone}</td>
                    <td>${membership.name}</td>
                    <td>
                        <span class="badge ${isActive ? 'badge-success' : 'badge-danger'}">
                            ${isActive ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-primary" onclick="viewClient('${client.cedula}')">Ver</button>
                        <button class="btn btn-warning" onclick="editClient('${client.cedula}')">Editar</button>
                        <button class="btn btn-danger" onclick="deleteClient('${client.cedula}')">Eliminar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Load memberships table
        function loadMembershipsTable() {
            const data = getGymData();
            const tableBody = document.getElementById('memberships-table');
            tableBody.innerHTML = '';
            
            data.memberships.forEach(membership => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${membership.id}</td>
                    <td>${membership.name}</td>
                    <td>${membership.description}</td>
                    <td>${membership.duration}</td>
                    <td>$${membership.price}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editMembership(${membership.id})">Editar</button>
                        <button class="btn btn-danger" onclick="deleteMembership(${membership.id})">Eliminar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Load attendance table
        function loadAttendanceTable() {
    const data = getGymData();
    const tableBody = document.getElementById('attendance-table');
    tableBody.innerHTML = '';
    
    // Ordenar por fecha m√°s reciente
    const sortedAttendance = [...data.attendance].sort((a, b) => {
        return new Date(`${b.date} ${b.time}`) - new Date(`${a.date} ${a.time}`);
    });
    
    sortedAttendance.forEach(attendance => {
        const client = getClientByCedula(attendance.client_cedula);
        const trainer = attendance.trainer_id ? getTrainerById(attendance.trainer_id) : null;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${attendance.client_cedula}</td>
            <td>${client ? client.name : 'Cliente no encontrado'}</td>
            <td>${formatDateTime(attendance.date, attendance.time)}</td>
            <td>${trainer ? trainer.name : 'Sin entrenador'}</td>
            <td>
                <span class="badge ${attendance.status === 'Confirmada' ? 'badge-success' : 'badge-danger'}">
                    ${attendance.status}
                </span>
            </td>
            <td>
                <button class="btn btn-warning" onclick="editAttendance(${attendance.id})">Editar</button>
                <button class="btn btn-danger" onclick="deleteAttendance(${attendance.id})">Eliminar</button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Funci√≥n corregida para cargar la tabla de pagos
function loadPaymentsTable() {
    const data = getGymData();
    const tableBody = document.getElementById('payments-table');
    tableBody.innerHTML = '';
    
    // Sort payments by date (newest first)
    const sortedPayments = [...data.payments].sort((a, b) => {
        return new Date(b.date) - new Date(a.date);
    });
    
    sortedPayments.forEach(payment => {
        // Get client safely
        const client = payment.client_cedula ? getClientByCedula(payment.client_cedula) : null;
        
        // Get membership safely - THIS WAS MISSING
        const membership = payment.membership_id ? getMembershipById(payment.membership_id) : null;
        
        // Calculate final amount with default value
        const finalAmount = payment.amount ? payment.amount * (1 - (payment.discount || 0) / 100) : 0;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${payment.client_cedula || 'N/A'}</td>
            <td>${client ? client.name : 'Cliente no encontrado'}</td>
            <td>${membership ? membership.name : 'Membres√≠a no encontrada'}</td>
            <td>$${finalAmount.toFixed(2)}</td>
            <td>${payment.method || 'N/A'}</td>
            <td>
                <span class="badge ${
                    payment.status === 'Pagado' ? 'badge-success' : 
                    payment.status === 'Pendiente' ? 'badge-warning' : 'badge-danger'
                }">
                    ${payment.status || 'Desconocido'}
                </span>
            </td>
            <td>${payment.date ? formatDate(payment.date) : 'N/A'}</td>
            <td>
                <button class="btn btn-warning" onclick="editPayment(${payment.id})">Editar</button>
                <button class="btn btn-danger" onclick="deletePayment(${payment.id})">Eliminar</button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

    // Load trainers table
    function loadTrainersTable() {
        const data = getGymData();
        const tableBody = document.getElementById('trainers-table');
        tableBody.innerHTML = '';
        
        data.trainers.forEach(trainer => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${trainer.id}</td>
                <td>${trainer.name}</td>
                <td>${trainer.specialty}</td>
                <td>${trainer.email}</td>
                <td>${trainer.phone}</td>
                <td>${trainer.schedule || 'No definido'}</td>
                <td>
                    <button class="btn btn-warning" onclick="editTrainer(${trainer.id})">Editar</button>
                    <button class="btn btn-danger" onclick="deleteTrainer(${trainer.id})">Eliminar</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }
    document.getElementById('trainer-phone').addEventListener('input', function(e) {
    // Remove any non-numeric characters
    this.value = this.value.replace(/[^0-9]/g, '');
    
    // Limit to 10 digits
    if (this.value.length > 10) {
        this.value = this.value.slice(0, 10);
    }
});
    // View client details
    function viewClient(cedula) {
    const data = getGymData();
    const client = data.clients.find(c => c.cedula === cedula);
    
    if (client) {
        const membership = getMembershipById(client.membership_id);
        const endDate = calculateEndDate(client.start_date, membership.duration);
        const isActive = isMembershipActive(client.start_date, membership.duration);
        
        // Set client details
        document.getElementById('view-client-id').textContent = client.cedula;
        document.getElementById('view-client-name').textContent = client.name;
        document.getElementById('view-client-email').textContent = client.email;
        document.getElementById('view-client-phone').textContent = client.phone;
        document.getElementById('view-client-birthdate').textContent = formatDate(client.birthdate);
        document.getElementById('view-client-gender').textContent = 
            client.gender === 'M' ? 'Masculino' : 
            client.gender === 'F' ? 'Femenino' : 'Otro';
        document.getElementById('view-client-membership').textContent = membership.name;
        document.getElementById('view-client-start-date').textContent = formatDate(client.start_date);
        document.getElementById('view-client-end-date').textContent = formatDate(endDate);
        document.getElementById('view-client-status').textContent = isActive ? 'Activo' : 'Inactivo';
        document.getElementById('client-view-name').textContent = `Cliente: ${client.name}`;
        
        // Cargar pagos del cliente
        const paymentsTable = document.getElementById('client-payments-table');
        paymentsTable.innerHTML = '';

        // üî¥ **Correcci√≥n aplicada**: Definir `clientId` correctamente
        const clientId = client.cedula; 

        data.payments
            .filter(p => p.client_id === clientId) // Aqu√≠ `clientId` ya est√° definido correctamente
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .forEach(payment => {
                const membership = getMembershipById(payment.membership_id);
                const finalAmount = payment.amount * (1 - payment.discount / 100);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payment.id}</td>
                    <td>${formatDate(payment.date)}</td>
                    <td>${membership ? membership.name : 'Membres√≠a eliminada'}</td>
                    <td>$${finalAmount.toFixed(2)}</td>
                    <td>
                        <span class="badge ${
                            payment.status === 'Pagado' ? 'badge-success' : 
                            payment.status === 'Pendiente' ? 'badge-warning' : 'badge-danger'
                        }">
                            ${payment.status}
                        </span>
                    </td>
                `;
                paymentsTable.appendChild(row);
            });

        // Mostrar modal
        openModal('client-view-modal');
    } else {
        console.error(`Error: No se encontr√≥ el cliente con c√©dula ${cedula}`);
    }
}


    // Edit client
    function editClient(cedula) {
        const data = getGymData();
        const client = data.clients.find(c => c.cedula === cedula);
        
        if (client) {
            // Set modal title
            document.getElementById('client-modal-title').textContent = 'Editar Cliente';
            
            // Fill form with client data
            document.getElementById('client-cedula').value = client.cedula;
            document.getElementById('client-name').value = client.name;
            document.getElementById('client-email').value = client.email;
            document.getElementById('client-phone').value = client.phone;
            document.getElementById('client-birthdate').value = client.birthdate;
            document.getElementById('client-gender').value = client.gender;
            document.getElementById('client-membership').value = client.membership_id;
            document.getElementById('client-start-date').value = client.start_date;
            
            // Show modal
            openModal('client-modal');
        }
    }

    // Delete client
    function deleteClient(cedula) {
        if (confirm('¬øEst√°s seguro de que deseas eliminar este cliente?')) {
            const data = getGymData();
            data.clients = data.clients.filter(c => c.cedula !== cedula);
            saveGymData(data);
            loadClientsTable();
            loadClientSelect();
            updateDashboardStats();
        }
    }

    // Edit membership
    function editMembership(membershipId) {
        const data = getGymData();
        const membership = data.memberships.find(m => m.id === membershipId);
        
        if (membership) {
            // Set modal title
            document.getElementById('membership-modal-title').textContent = 'Editar Membres√≠a';
            
            // Fill form with membership data
            document.getElementById('membership-id').value = membership.id;
            document.getElementById('membership-name').value = membership.name;
            document.getElementById('membership-description').value = membership.description;
            document.getElementById('membership-duration').value = membership.duration;
            document.getElementById('membership-price').value = membership.price;
            
            // Show modal
            openModal('membership-modal');
        }
    }

    // Delete membership
    function deleteMembership(membershipId) {
        // Check if membership is being used by any client
        const data = getGymData();
        const clientUsingMembership = data.clients.some(c => c.membership_id === membershipId);
        
        if (clientUsingMembership) {
            alert('No se puede eliminar esta membres√≠a porque est√° siendo utilizada por al menos un cliente.');
            return;
        }
        
        if (confirm('¬øEst√°s seguro de que deseas eliminar esta membres√≠a?')) {
            data.memberships = data.memberships.filter(m => m.id !== membershipId);
            saveGymData(data);
            loadMembershipsTable();
            loadClientMembershipSelect();
            loadPaymentMembershipSelect();
            loadMembershipTypeSelect();
        }
    }

    // Edit attendance
    function editAttendance(attendanceId) {
    const data = getGymData();
    const attendance = data.attendance.find(a => a.id === attendanceId);
    
    if (attendance) {
        document.getElementById('attendance-modal-title').textContent = 'Editar Asistencia';
        document.getElementById('attendance-id').value = attendance.id;
        document.getElementById('attendance-client').value = attendance.client_cedula;
        document.getElementById('attendance-date').value = attendance.date;
        document.getElementById('attendance-time').value = attendance.time;
        document.getElementById('attendance-trainer').value = attendance.trainer_id || '';
        document.getElementById('attendance-status').value = attendance.status;
        
        // Actualizar el nombre del cliente
        const client = getClientByCedula(attendance.client_cedula);
        if (client) {
            document.getElementById('attendance-client-name').value = client.name;
        }
        
        openModal('attendance-modal');
    }
}
    // Delete attendance
    function deleteAttendance(attendanceId) {
        if (confirm('¬øEst√°s seguro de que deseas eliminar este registro de asistencia?')) {
            const data = getGymData();
            data.attendance = data.attendance.filter(a => a.id !== attendanceId);
            saveGymData(data);
            loadAttendanceTable();
            
            // Also refresh the attendance filter if it's active
            const clientFilter = document.getElementById('attendance-client-filter').value;
            if (clientFilter) {
                filterAttendanceByClient(clientFilter);
            }
        }
    }

    // Edit trainer
    function editTrainer(trainerId) {
        const data = getGymData();
        const trainer = data.trainers.find(t => t.id === trainerId);
        
        if (trainer) {
            // Set modal title
            document.getElementById('trainer-modal-title').textContent = 'Editar Entrenador';
            
            // Fill form with trainer data
            document.getElementById('trainer-id').value = trainer.id;
            document.getElementById('trainer-name').value = trainer.name;
            document.getElementById('trainer-specialty').value = trainer.specialty;
            document.getElementById('trainer-email').value = trainer.email;
            document.getElementById('trainer-phone').value = trainer.phone;
            document.getElementById('trainer-schedule').value = trainer.schedule || '';
            
            // Show modal
            openModal('trainer-modal');
        }
    }

    // Delete trainer
    function deleteTrainer(trainerId) {
        // Check if trainer is assigned to any attendance
        const data = getGymData();
        const attendanceUsingTrainer = data.attendance.some(a => a.trainer_id === trainerId);
        
        if (attendanceUsingTrainer) {
            alert('No se puede eliminar este entrenador porque est√° asignado a sesiones de entrenamiento.');
            return;
        }
        
        if (confirm('¬øEst√°s seguro de que deseas eliminar este entrenador?')) {
            data.trainers = data.trainers.filter(t => t.id !== trainerId);
            saveGymData(data);
            loadTrainersTable();
            loadTrainerSelect();
        }
    }

    // Edit payment
    function editPayment(paymentId) {
        const data = getGymData();
        const payment = data.payments.find(p => p.id === paymentId);
        
        if (payment) {
            // Set modal title
            document.getElementById('payment-modal-title').textContent = 'Editar Pago';
            
            // Fill form with payment data
            document.getElementById('payment-id').value = payment.id;
            document.getElementById('payment-client').value = payment.client_cedula;
            document.getElementById('payment-membership').value = payment.membership_id;
            document.getElementById('payment-amount').value = payment.amount;
            document.getElementById('payment-discount').value = payment.discount;
            document.getElementById('payment-method').value = payment.method;
            document.getElementById('payment-status').value = payment.status;
            document.getElementById('payment-date').value = payment.date;
            
            const client = getClientByCedula(payment.client_cedula);
            if (client) {
    document.getElementById('payment-client-name').value = client.name;
} else {
    document.getElementById('payment-client-name').value = '';
}

            // Show modal
            openModal('payment-modal');
        }
    }

    // Delete payment
    function deletePayment(paymentId) {
        if (confirm('¬øEst√°s seguro de que deseas eliminar este registro de pago?')) {
            const data = getGymData();
            data.payments = data.payments.filter(p => p.id !== paymentId);
            saveGymData(data);
            loadPaymentsTable();
        }
    }
    
    // Guardar o actualizar pago
document.getElementById('payment-form').addEventListener('submit', function (e) {
    e.preventDefault();

    const data = getGymData();
    const id = document.getElementById('payment-id').value;
    const cedula = document.getElementById('payment-client').value;
    const membershipId = parseInt(document.getElementById('payment-membership').value);
    const amount = parseFloat(document.getElementById('payment-amount').value);
    const discount = parseFloat(document.getElementById('payment-discount').value) || 0;
    const method = document.getElementById('payment-method').value;
    const status = document.getElementById('payment-status').value;
    const date = document.getElementById('payment-date').value;

    if (id) {
        // üîÑ Editar pago existente
        const index = data.payments.findIndex(p => p.id === parseInt(id));
        if (index !== -1) {
            data.payments[index] = {
                ...data.payments[index],
                client_cedula: cedula,
                membership_id: membershipId,
                amount,
                discount,
                method,
                status,
                date
            };
        }
    } else {
        // ‚ûï Crear nuevo pago
        const newPayment = {
            id: generateId('payments'),
            client_cedula: cedula,
            membership_id: membershipId,
            amount,
            discount,
            method,
            status,
            date
        };
        data.payments.push(newPayment);
    }

    saveGymData(data);
    loadPaymentsTable();
    closeModal('payment-modal');
    this.reset(); // Limpia el formulario
});

    // Filter attendance by client
    function filterAttendanceByClient(clientId) {
        const data = getGymData();
        const tableBody = document.getElementById('attendance-table');
        tableBody.innerHTML = '';
        
        let filteredAttendance = data.attendance;
        
        if (clientId) {
            filteredAttendance = data.attendance.filter(a => a.client_cedula === parseInt(cedula));
        }
        
        // Sort by date (newest first)
        filteredAttendance.sort((a, b) => {
            const dateA = new Date(a.date + 'T' + a.time);
            const dateB = new Date(b.date + 'T' + b.time);
            return dateB - dateA;
        });
        
        filteredAttendance.forEach(attendance => {
            const client = getClientByCedula(attendance.client_cedula);
            const trainer = attendance.trainer_id ? getTrainerById(attendance.trainer_id) : null;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${attendance.id}</td>
                <td>${client ? client.name : 'Cliente eliminado'}</td>
                <td>${formatDateTime(attendance.date, attendance.time)}</td>
                <td>${trainer ? trainer.name : 'Ninguno'}</td>
                <td>
                    <span class="badge ${attendance.status === 'Confirmada' ? 'badge-success' : 'badge-danger'}">
                        ${attendance.status}
                    </span>
                </td>
                <td>
                    <button class="btn btn-warning" onclick="editAttendance(${attendance.id})">Editar</button>
                    <button class="btn btn-danger" onclick="deleteAttendance(${attendance.id})">Eliminar</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // Handle attendance filter change
    document.getElementById('attendance-client-filter').addEventListener('change', function() {
        filterAttendanceByClient(this.value);
    });

    // Generate attendance report
    function generateAttendanceReport() {
    const clientId = document.getElementById('attendance-report-client').value;
    const dateFrom = document.getElementById('attendance-report-date-from').value;
    const dateTo = document.getElementById('attendance-report-date-to').value;
    
    const data = getGymData();
    let filteredAttendance = [...data.attendance];
    
    // Aplicar filtros
    if (clientId) {
        filteredAttendance = filteredAttendance.filter(a => a.client_cedula === clientId);
    }
    
    if (dateFrom && dateTo) {
        filteredAttendance = filteredAttendance.filter(a => {
            const attendanceDate = new Date(a.date);
            return attendanceDate >= new Date(dateFrom) && 
                   attendanceDate <= new Date(dateTo);
        });
    }
    
    // Ordenar por fecha
    filteredAttendance.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Generar reporte
    const tableBody = document.getElementById('attendance-report-table');
    tableBody.innerHTML = '';
    
    if (filteredAttendance.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No se encontraron registros</td></tr>';
        return;
    }
    
    filteredAttendance.forEach(attendance => {
        const client = getClientByCedula(attendance.client_cedula);
        const trainer = attendance.trainer_id ? getTrainerById(attendance.trainer_id) : null;
        const membership = client ? getMembershipById(client.membership_id) : null;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${attendance.id}</td>
            <td>${formatDateTime(attendance.date, attendance.time)}</td>
            <td>${client ? client.name : 'Cliente no encontrado'}</td>
            <td>${trainer ? trainer.name : 'Sin entrenador'}</td>
            <td>${membership ? membership.name : 'N/A'}</td>
            <td>
                <span class="badge ${attendance.status === 'Confirmada' ? 'badge-success' : 'badge-danger'}">
                    ${attendance.status}
                </span>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

    // Generate income report
    function generateIncomeReport() {
    const dateRange = document.getElementById('income-date-range').value;
    const membershipType = document.getElementById('income-membership-type').value;
    const paymentMethod = document.getElementById('income-payment-method').value;
    
    const data = getGymData();
    let filteredPayments = data.payments.filter(p => p.status === 'Pagado');
    
    // Calculate date range
    const today = new Date();
    let startDate, endDate;
    
    switch(dateRange) {
        case 'day':
            startDate = new Date(today.setHours(0,0,0,0));
            endDate = new Date(today.setHours(23,59,59,999));
            break;
        case 'week':
            startDate = new Date(today.setDate(today.getDate() - today.getDay()));
            endDate = new Date(today.setDate(today.getDate() + 6));
            break;
        case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            break;
        case 'year':
            startDate = new Date(today.getFullYear(), 0, 1);
            endDate = new Date(today.getFullYear(), 11, 31);
            break;
    }
    
    // Apply filters
    filteredPayments = filteredPayments.filter(payment => {
        const paymentDate = new Date(payment.date);
        const matchesDate = paymentDate >= startDate && paymentDate <= endDate;
        const matchesMembership = !membershipType || payment.membership_id.toString() === membershipType;
        const matchesMethod = !paymentMethod || payment.method === paymentMethod;
        
        return matchesDate && matchesMembership && matchesMethod;
    });
    
    // Generate report
    const tableBody = document.getElementById('income-report-table');
    tableBody.innerHTML = '';
    let totalIncome = 0;
    
    if (filteredPayments.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="9" class="text-center">No se encontraron pagos para el per√≠odo seleccionado</td></tr>';
        document.getElementById('income-total').innerHTML = '<strong>$0.00</strong>';
        return;
    }
    
    filteredPayments.forEach(payment => {
        const client = getClientByCedula(payment.client_cedula);
        const membership = getMembershipById(payment.membership_id);
        const finalAmount = payment.amount * (1 - (payment.discount || 0) / 100);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${payment.client_cedula}</td>
            <td>${formatDate(payment.date)}</td>
            <td>${client ? client.name : 'Cliente no encontrado'}</td>
            <td>${membership ? membership.name : 'Membres√≠a no encontrada'}</td>
            <td>$${payment.amount.toFixed(2)}</td>
            <td>${payment.discount || 0}%</td>
            <td>$${finalAmount.toFixed(2)}</td>
            <td>${payment.method}</td>
            <td><span class="badge badge-success">${payment.status}</span></td>
        `;
        tableBody.appendChild(row);
        totalIncome += finalAmount;
    });
    
    document.getElementById('income-total').innerHTML = `<strong>$${totalIncome.toFixed(2)}</strong>`;


        
    function updateMembershipSummary(activeMemberships, inactiveMemberships, filteredClients) {
    try {
        const elements = {
            active: document.getElementById('membership-report-active'),
            inactive: document.getElementById('membership-report-inactive'),
            total: document.getElementById('membership-report-total')
        };
        
        if (!elements.active || !elements.inactive || !elements.total) {
            console.error('One or more summary elements not found');
            return;
        }
        
        elements.active.textContent = activeMemberships.length;
        elements.inactive.textContent = inactiveMemberships.length;
        elements.total.textContent = filteredClients.length;
    } catch (error) {
        console.error('Error updating membership summary:', error);
    }
    }
}

    function generateMembershipReport() {
    const status = document.getElementById('membership-report-status').value;
    const type = document.getElementById('membership-report-type').value;
    
    const data = getGymData();
    let filteredClients = [...data.clients];
    
    // Aplicar filtros
    filteredClients = filteredClients.filter(client => {
        const membership = getMembershipById(client.membership_id);
        if (!membership) return false;
        
        const isActive = isMembershipActive(client.start_date, membership.duration);
        const matchesStatus = !status || 
            (status === 'Activo' && isActive) || 
            (status === 'Inactivo' && !isActive);
        const matchesType = !type || membership.id.toString() === type;
        
        return matchesStatus && matchesType;
    });
    
    // Generar reporte
    const tableBody = document.getElementById('membership-report-table');
    tableBody.innerHTML = '';
    
    if (filteredClients.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No se encontraron registros</td></tr>';
        return;
    }
    
    filteredClients.forEach(client => {
        const membership = getMembershipById(client.membership_id);
        const isActive = isMembershipActive(client.start_date, membership.duration);
        const lastAttendance = getLastAttendance(client.cedula);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${client.cedula}</td>
            <td>${client.name}</td>
            <td>${membership.name}</td>
            <td>${formatDate(client.start_date)}</td>
            <td>
                <span class="badge ${isActive ? 'badge-success' : 'badge-danger'}">
                    ${isActive ? 'Activo' : 'Inactivo'}
                </span>
            </td>
            <td>${lastAttendance ? formatDateTime(lastAttendance.date, lastAttendance.time) : 'Nunca'}</td>
        `;
        tableBody.appendChild(row);
    });
}

// Funci√≥n auxiliar para obtener la √∫ltima asistencia
function getLastAttendance(cedula) {
    const data = getGymData();
    return data.attendance
        .filter(a => a.client_cedula === cedula && a.status === 'Confirmada')
        .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
}


    // Generate trainer report
    function generateTrainerReport() {
    // Obtener el valor del filtro
    const trainerId = document.getElementById('trainer-report-trainer').value;
    
    // Obtener los datos del gimnasio
    const data = getGymData();
    let filteredTrainers = data.trainers;
    
    // Aplicar filtro si existe
    if (trainerId) {
        filteredTrainers = filteredTrainers.filter(t => t.id == trainerId);
    }
    
    // Generar la tabla de resultados
    const tableBody = document.getElementById('trainer-report-table');
    tableBody.innerHTML = '';
    
    filteredTrainers.forEach(trainer => {
        // Calcular m√©tricas para cada entrenador
        const assignedClients = new Set();
        let sessionsCount = 0;
        let lastSession = null;
        
        data.attendance.forEach(attendance => {
            if (attendance.trainer_id === trainer.id) {
                assignedClients.add(attendance.client_cedula);
                sessionsCount++;
                
                const sessionDate = new Date(attendance.date + 'T' + attendance.time);
                if (!lastSession || sessionDate > new Date(lastSession.date + 'T' + lastSession.time)) {
                    lastSession = attendance;
                }
            }
        });
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${trainer.id}</td>
            <td>${trainer.name}</td>
            <td>${assignedClients.size}</td>
            <td>${sessionsCount}</td>
            <td>${lastSession ? formatDateTime(lastSession.date, lastSession.time) : 'Ninguna'}</td>
        `;
        tableBody.appendChild(row);
    });
}
// Event listeners para los botones de reportes
document.getElementById('generate-income-report').addEventListener('click', generateIncomeReport);
document.getElementById('generate-attendance-report').addEventListener('click', generateAttendanceReport);
document.getElementById('generate-membership-report').addEventListener('click', generateMembershipReport);
// Obtiene los datos del gimnasio desde localStorage
function getGymData() {
    return JSON.parse(localStorage.getItem('gymData')) || {
        clients: [],
        trainers: [],
        memberships: [],
        attendance: [],
        payments: []
    };
}

// Formatea una fecha como string (ej: "01/01/2023")
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString();
}

// Formatea fecha y hora (ej: "01/01/2023 10:30 AM")
function formatDateTime(dateString, timeString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    if (timeString) {
        const [hours, minutes] = timeString.split(':');
        date.setHours(hours, minutes);
    }
    return date.toLocaleString();
}

// Calcula la fecha de finalizaci√≥n de una membres√≠a
function calculateEndDate(startDate, duration) {
    const date = new Date(startDate);
    
    switch(duration) {
        case 'mensual': date.setMonth(date.getMonth() + 1); break;
        case 'trimestral': date.setMonth(date.getMonth() + 3); break;
        case 'semestral': date.setMonth(date.getMonth() + 6); break;
        case 'anual': date.setFullYear(date.getFullYear() + 1); break;
    }
    
    return date.toISOString().split('T')[0];
}

// Verifica si una membres√≠a est√° activa
function isMembershipActive(startDate, duration) {
    const endDate = new Date(calculateEndDate(startDate, duration));
    return new Date() <= endDate;
}

// Obtiene un cliente por su c√©dula
function getClientByCedula(cedula) {
    const data = getGymData();
    return data.clients.find(client => client.cedula === cedula);
}

// Obtiene una membres√≠a por su ID
function getMembershipById(id) {
    const data = getGymData();
    return data.memberships.find(membership => membership.id == id);
}

// Obtiene un entrenador por su ID
function getTrainerById(id) {
    const data = getGymData();
    return data.trainers.find(trainer => trainer.id == id);
}


// Funci√≥n principal para cargar membres√≠as pr√≥ximas a vencer
function loadExpiringMemberships() {
    const data = getGymData();
    const tableBody = document.getElementById('expiring-memberships');
    tableBody.innerHTML = '';

    const today = new Date();
    today.setHours(0, 0, 0, 0); // Normalizar fecha
    const nextWeek = new Date();
    nextWeek.setDate(today.getDate() + 7);
    nextWeek.setHours(23, 59, 59, 999);

    // Obtener y procesar membres√≠as
    const expiringMemberships = data.clients
        .map(client => {
            const membership = getMembershipById(client.membership_id);
            if (!membership || !client.start_date) return null;

            const endDate = new Date(calculateEndDate(client.start_date, membership.duration));
            endDate.setHours(0, 0, 0, 0);
            
            return { client, membership, endDate };
        })
        .filter(Boolean) // Eliminar nulos
        .filter(item => item.endDate >= today && item.endDate <= nextWeek)
        .sort((a, b) => a.endDate - b.endDate); // Ordenar por fecha m√°s pr√≥xima

    // Mostrar resultados
    if (expiringMemberships.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center">No hay membres√≠as por vencer en la pr√≥xima semana</td></tr>`;
        return;
    }

    expiringMemberships.forEach(({client, membership, endDate}) => {
        const row = document.createElement('tr');
        const daysLeft = Math.ceil((endDate - today) / (86400000)); // 1 d√≠a en ms
        
        // Resaltar si vence hoy
        if (daysLeft === 0) {
            row.classList.add('urgent-expiration');
        }

        row.innerHTML = `
            <td>${client.cedula || 'N/A'}</td>
            <td>${client.name || 'Sin nombre'}</td>
            <td>${membership.name} (${membership.duration})</td>
            <td>
                ${formatDate(endDate)}
                <span class="expiration-badge ${
                    daysLeft <= 1 ? 'bg-danger-light' : 'bg-warning-light'
                }">
                    ${daysLeft === 0 ? 'Vence hoy' : `Vence en ${daysLeft} d√≠a(s)`}
                </span>
            </td>
            <td>
                <button class="btn btn-primary btn-sm" onclick="renewMembership('${client.cedula}')">
                    Renovar
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="sendReminder('${client.cedula}')">
                    <i class="bi bi-envelope"></i> Recordatorio
                </button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Funci√≥n para renovar membres√≠a
function renewMembership(clientCedula) {
    const data = getGymData();
    const client = data.clients.find(c => c.cedula === clientCedula);
    
    if (client) {
        // Prellenar formulario de pago
        document.getElementById('payment-client').value = client.cedula;
        document.getElementById('payment-membership').value = client.membership_id;
        document.getElementById('payment-amount').value = getMembershipById(client.membership_id).price;
        
        // Establecer fecha de hoy
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('payment-date').value = today;
        
        openModal('payment-modal');
    } else {
        alert('Cliente no encontrado');
    }
}

// Funci√≥n para enviar recordatorio (simulado)
function sendReminder(clientCedula) {
    const client = getClientByCedula(clientCedula);
    if (client) {
        // En una implementaci√≥n real, aqu√≠ ir√≠a el c√≥digo para enviar email
        console.log(`Enviando recordatorio a ${client.email}`);
        alert(`Se envi√≥ un recordatorio a ${client.name} (${client.email})`);
    } else {
        alert('Cliente no encontrado');
    }
}

// Llamar esta funci√≥n cuando se actualice el dashboard
function updateDashboardStats() {
    // ... otras funciones de actualizaci√≥n ...
    loadExpiringMemberships();
}
    // Modal Functions
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // Close modal when clicking on X or outside the modal
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal-close') || event.target.hasAttribute('data-close')) {
            const modalId = event.target.getAttribute('data-close') || event.target.closest('.modal').id;
            closeModal(modalId);
        }
        
        if (event.target.classList.contains('modal')) {
            closeModal(event.target.id);
        }
    });

    // Tab functionality
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            
            // Remove active class from all buttons and contents
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked button and corresponding content
            this.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        });
    });

    function loadRecentAttendance() {
    const data = getGymData();
    const tableBody = document.getElementById('recent-attendance');
    tableBody.innerHTML = '';

    // Ordenar por fecha m√°s reciente primero
    const sortedAttendance = [...data.attendance].sort((a, b) => {
        const dateA = new Date(`${a.date}T${a.time}`);
        const dateB = new Date(`${b.date}T${b.time}`);
        return dateB - dateA;
    }).slice(0, 10); // Mostrar solo las 10 m√°s recientes

    if (sortedAttendance.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center">No hay registros de asistencia recientes</td></tr>`;
        return;
    }

    sortedAttendance.forEach(attendance => {
        const client = getClientByCedula(attendance.client_cedula);
        const trainer = attendance.trainer_id ? getTrainerById(attendance.trainer_id) : null;
        const attendanceDate = new Date(`${attendance.date}T${attendance.time}`);
        
        // Calcular tiempo transcurrido
        const now = new Date();
        const hoursDiff = Math.floor((now - attendanceDate) / (1000 * 60 * 60));
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${attendance.client_cedula}</td>
            <td>${client ? client.name : 'Cliente no encontrado'}</td>
            <td>
                ${formatDateTime(attendance.date, attendance.time)}
                ${hoursDiff < 24 ? `<span class="badge bg-success">Hoy</span>` : ''}
            </td>
            <td>${trainer ? trainer.name : 'Sin entrenador'}</td>
            <td>
                <span class="badge ${
                    attendance.status === 'Confirmada' ? 'bg-success' : 'bg-danger'
                }">
                    ${attendance.status}
                </span>
            </td>
            <td>
                <button class="btn btn-outline-primary btn-sm" onclick="viewAttendanceDetails(${attendance.id})">
                    <i class="bi bi-eye"></i>
                </button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

function viewAttendanceDetails(attendanceId) {
    const data = getGymData();
    const attendance = data.attendance.find(a => a.id === attendanceId);
    
    if (!attendance) {
        alert('Registro de asistencia no encontrado');
        return;
    }

    const client = getClientByCedula(attendance.client_cedula);
    const trainer = attendance.trainer_id ? getTrainerById(attendance.trainer_id) : null;
    const membership = client ? getMembershipById(client.membership_id) : null;

    // Crear contenido del modal (puedes usar un modal existente o crear uno nuevo)
    const modalContent = `
        <div class="modal-header">
            <h5 class="modal-title">Detalles de Asistencia</h5>
            <button type="button" class="btn-close" data-close="attendance-details-modal"></button>
        </div>
        <div class="modal-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <p><strong>Cliente:</strong> ${client ? client.name : 'N/A'}</p>
                    <p><strong>C√©dula:</strong> ${attendance.client_cedula}</p>
                    <p><strong>Membres√≠a:</strong> ${membership ? membership.name : 'N/A'}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Fecha/Hora:</strong> ${formatDateTime(attendance.date, attendance.time)}</p>
                    <p><strong>Estado:</strong> 
                        <span class="badge ${
                            attendance.status === 'Confirmada' ? 'bg-success' : 'bg-danger'
                        }">
                            ${attendance.status}
                        </span>
                    </p>
                    <p><strong>Entrenador:</strong> ${trainer ? trainer.name : 'N/A'}</p>
                </div>
            </div>
            ${attendance.notes ? `<div class="alert alert-info"><strong>Notas:</strong> ${attendance.notes}</div>` : ''}
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-close="attendance-details-modal">Cerrar</button>
            <button type="button" class="btn btn-primary" onclick="editAttendance(${attendance.id})">
                Editar Registro
            </button>
        </div>
    `;

    // Mostrar modal (asumiendo que tienes un modal con id 'attendance-details-modal')
    const modal = document.getElementById('attendance-details-modal');
    modal.querySelector('.modal-content').innerHTML = modalContent;
    openModal('attendance-details-modal');
}

    // Form submissions
 // Client form
 document.getElementById('client-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const data = getGymData();
    
    // Extract form values
    const cedula = document.getElementById('client-cedula').value.trim();
    const name = document.getElementById('client-name').value;
    const email = document.getElementById('client-email').value;
    const phone = document.getElementById('client-phone').value;
    const birthdate = document.getElementById('client-birthdate').value;
    const gender = document.getElementById('client-gender').value;
    const membership_id = document.getElementById('client-membership').value;
    const start_date = document.getElementById('client-start-date').value;

    // Create new client object
    const newClient = {
        cedula: cedula,  // Guardar como string
        name: document.getElementById('client-name').value,
        email: document.getElementById('client-email').value,
        phone: document.getElementById('client-phone').value,
        birthdate: document.getElementById('client-birthdate').value,
        gender: document.getElementById('client-gender').value,
        membership_id: parseInt(document.getElementById('client-membership').value),
        start_date: document.getElementById('client-start-date').value
    };
    
    // Check if we're editing an existing client or adding a new one
    const existingIndex = data.clients.findIndex(c => c.cedula === cedula);
    
    if (existingIndex !== -1) {
        // Update existing client
        data.clients[existingIndex] = newClient;
    } else {
        // Add new client
        data.clients.push(newClient);
    }
    
    // Save the data
    saveGymData(data);
    
    // Refresh UI
    loadClientsTable();
    loadClientSelect();
    updateDashboardStats();
    
    // Close modal and reset form
    closeModal('client-modal');
    this.reset();
});

    // Membership form
    document.getElementById('membership-form').addEventListener('submit', function(event) {
        event.preventDefault();
        
        const data = getGymData();
        const membershipId = document.getElementById('membership-id').value;
        
        const membership = {
            name: document.getElementById('membership-name').value,
            description: document.getElementById('membership-description').value,
            duration: document.getElementById('membership-duration').value,
            price: parseFloat(document.getElementById('membership-price').value)
        };
        
        if (membershipId) {
            // Update existing membership
            membership.id = parseInt(membershipId);
            const index = data.memberships.findIndex(m => m.id === membership.id);
            if (index !== -1) {
                data.memberships[index] = membership;
            }
        } else {
            // Add new membership
            membership.id = data.memberships.length > 0 ? 
                Math.max(...data.memberships.map(m => m.id)) + 1 : 1;
            data.memberships.push(membership);
        }
        
        saveGymData(data);
        loadMembershipsTable();
        loadClientMembershipSelect();
        loadPaymentMembershipSelect();
        loadMembershipTypeSelect();
        updateDashboardStats();
        closeModal('membership-modal');
        this.reset();
        document.getElementById('membership-id').value = '';
    });

    // Attendance form
    document.getElementById('attendance-form').addEventListener('submit', function(event) {
    event.preventDefault();
    
    const data = getGymData();
    const attendanceId = document.getElementById('attendance-id').value;
    
    // Crear objeto de asistencia
    const attendance = {
        id: attendanceId ? parseInt(attendanceId) : generateId('attendance'),
        client_cedula: document.getElementById('attendance-client').value,
        date: document.getElementById('attendance-date').value,
        time: document.getElementById('attendance-time').value,
        trainer_id: document.getElementById('attendance-trainer').value || null,
        status: document.getElementById('attendance-status').value
    };
    
    if (attendanceId) {
        // Actualizar asistencia existente
        const index = data.attendance.findIndex(a => a.id === parseInt(attendanceId));
        if (index !== -1) {
            data.attendance[index] = attendance;
        }
    } else {
        // Agregar nueva asistencia
        data.attendance.push(attendance);
    }
    
    saveGymData(data);
    loadAttendanceTable();
    loadRecentAttendance();
    updateDashboardStats();
    
    closeModal('attendance-modal');
    this.reset();
});
   
    // Trainer form
    document.getElementById('trainer-form').addEventListener('submit', function(event) {
    event.preventDefault();
    
    const data = getGymData();
    const trainerId = document.getElementById('trainer-id').value;
    
    const trainer = {
        name: document.getElementById('trainer-name').value,
        specialty: document.getElementById('trainer-specialty').value,
        email: document.getElementById('trainer-email').value,
        phone: document.getElementById('trainer-phone').value,
        schedule: document.getElementById('trainer-schedule').value
    };
    
    if (trainerId) {
        // Update existing trainer
        trainer.id = parseInt(trainerId);
        const index = data.trainers.findIndex(t => t.id === trainer.id);
        if (index !== -1) {
            data.trainers[index] = trainer;
        }
    } else {
        // Add new trainer
        trainer.id = generateId('trainers');
        data.trainers.push(trainer);
    }
    
    saveGymData(data);
    loadTrainersTable();
    loadTrainerSelect();
    closeModal('trainer-modal');
    this.reset();
        document.getElementById('trainer-id').value = '';
        });
    
 
        // Payment form
        document.getElementById('payment-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const data = getGymData();
    loadExpiringMemberships();

    // Validar campos obligatorios
    const clientId = document.getElementById('payment-client').value;
    const membershipId = document.getElementById('payment-membership').value;
    const amount = document.getElementById('payment-amount').value;
    const date = document.getElementById('payment-date').value;

    if (!clientId || !membershipId || !amount || !date) {
        alert('Por favor complete todos los campos obligatorios');
        return;
    }

    // Validar que exista el cliente
    const client = getClientByCedula(clientId);
    if (!client) {
        alert('El cliente seleccionado no existe');
        return;
    }

    // Validar que exista la membres√≠a
    const membership = getMembershipById(membershipId);
    if (!membership) {
        alert('La membres√≠a seleccionada no existe');
        return;
    }

    // Crear objeto de pago
    const payment = {
        id: generateId('payments'),
        client_cedula: clientId,
        membership_id: parseInt(membershipId),
        amount: parseFloat(amount),
        discount: parseFloat(document.getElementById('payment-discount').value) || 0,
        method: document.getElementById('payment-method').value,
        status: document.getElementById('payment-status').value,
        date: date
    };

    // Validar descuento
    if (payment.discount < 0 || payment.discount > 100) {
        alert('El descuento debe estar entre 0 y 100%');
        return;
    }

    data.payments.push(payment);
    saveGymData(data);

    // Actualizar UI
    loadPaymentsTable();
    updateDashboardStats();
    
    // Cerrar modal y resetear formulario
    closeModal('payment-modal');
    this.reset();
});
    
 
        // Close modal when clicking on X or outside the modal
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal-close') || event.target.hasAttribute('data-close')) {
                const modalId = event.target.getAttribute('data-close');
                closeModal(modalId);
            }
        });
    
        // Tab functionality
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', function() {
                const tab = this.getAttribute('data-tab');
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(tab).classList.add('active');
            });
        });

        document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', function() {
        if (this.getAttribute('data-page') === 'dashboard') {
            updateDashboardStats();
        }
        // Ocultar todas las p√°ginas
        document.querySelectorAll('.page').forEach(page => {
            page.style.display = 'none';
        });
        

        // Obtener el atributo "data-page" del elemento clickeado
        const pageId = this.getAttribute('data-page') + '-page';

        // Mostrar la p√°gina seleccionada
        document.getElementById(pageId).style.display = 'block';

        // Cambiar el t√≠tulo de la p√°gina
        document.getElementById('page-title').innerText = this.innerText;

        // Remover la clase 'active' de todos los elementos y agregarla al actual
        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
        this.classList.add('active');
    });
});
document.getElementById('add-trainer-btn').addEventListener('click', function() {
    // Limpiar el formulario antes de abrir el modal
    document.getElementById('trainer-form').reset();
    document.getElementById('trainer-id').value = '';
    document.getElementById('trainer-modal-title').textContent = 'Agregar Entrenador';
    
    // Abrir el modal
    openModal('trainer-modal');
});

// Listener para abrir el modal de clientes al hacer clic en "+ Agregar Cliente"
document.getElementById('add-client-btn').addEventListener('click', function() {
    // Reinicia el formulario para limpiar datos anteriores
    document.getElementById('client-form').reset();
    // Cambia el t√≠tulo del modal a "Agregar Cliente"
    document.getElementById('client-modal-title').textContent = 'Agregar Cliente';
    // Abre el modal
    openModal('client-modal');
});

// Funci√≥n para abrir un modal (usa display: flex, seg√∫n tu CSS)
function openModal(modalId) {
    var modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
    }
}

// Funci√≥n para cerrar un modal
function closeModal(modalId) {
    var modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
}

// Asigna un listener a todos los botones que tengan el atributo data-close,
// para que al hacer clic cierren el modal correspondiente.
document.querySelectorAll('[data-close]').forEach(function(button) {
    button.addEventListener('click', function() {
        var modalId = this.getAttribute('data-close');
        closeModal(modalId);
    });
});

document.getElementById('add-membership-btn') && document.getElementById('add-membership-btn').addEventListener('click', function() {
    document.getElementById('membership-form').reset();
    document.getElementById('membership-modal-title').textContent = 'Agregar Membres√≠a';
    openModal('membership-modal');
});
document.getElementById('add-attendance-btn') && document.getElementById('add-attendance-btn').addEventListener('click', function() {
    document.getElementById('attendance-form').reset();
    document.getElementById('attendance-modal-title').textContent = 'Registrar Asistencia';
    // Asigna la fecha actual (formato YYYY-MM-DD)
    var today = new Date().toISOString().split('T')[0];
    document.getElementById('attendance-date').value = today;
    
    // Asigna la hora actual en formato HH:MM
    var now = new Date();
    var hours = now.getHours().toString().padStart(2, '0');
    var minutes = now.getMinutes().toString().padStart(2, '0');
    document.getElementById('attendance-time').value = hours + ':' + minutes;
    openModal('attendance-modal');
});
document.getElementById('add-payment-btn') && document.getElementById('add-payment-btn').addEventListener('click', function() {
    document.getElementById('payment-form').reset();
    document.getElementById('payment-modal-title').textContent = 'Registrar Pago';
    openModal('payment-modal');
    
});

// Funciones para abrir y cerrar modals
function openModal(modalId) {
    var modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
    }
}
function closeModal(modalId) {
    var modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
}
// Listener para botones con data-close
document.querySelectorAll('[data-close]').forEach(function(button) {
    button.addEventListener('click', function() {
        var modalId = this.getAttribute('data-close');
        closeModal(modalId);
    });
});

// Listener para el select de clientes en el modal de asistencia
document.getElementById('attendance-client').addEventListener('change', function() {
    const cedula = this.value;
    const client = getClientByCedula(cedula);
    const clientNameInput = document.getElementById('attendance-client-name');
    
    if (client) {
        clientNameInput.value = client.name;
        // Verificar si la membres√≠a est√° activa
        const membership = getMembershipById(client.membership_id);
        if (!isMembershipActive(client.start_date, membership.duration)) {
            alert('Advertencia: Este cliente no tiene una membres√≠a activa');
        }
    } else {
        clientNameInput.value = '';
        if (cedula) {
            alert('Cliente no encontrado');
        }
    }
});
function updateDashboardStats() {
    const data = getGymData();
    
    // Contar clientes activos
    const activeClients = data.clients.filter(client => {
        const membership = getMembershipById(client.membership_id);
        return membership && isMembershipActive(client.start_date, membership.duration);
    }).length;
    
    // Contar asistencias hoy
    const today = new Date().toISOString().split('T')[0];
    const todayAttendance = data.attendance.filter(a => a.date === today && a.status === 'Confirmada').length;
    
    // Contar entrenadores
    const trainersCount = data.trainers.length;
    
    // Calcular ingresos mensuales
    const currentMonth = new Date().getMonth() + 1;
    const currentYear = new Date().getFullYear();
    const monthlyIncome = data.payments
        .filter(p => {
            const paymentDate = new Date(p.date);
            return paymentDate.getMonth() + 1 === currentMonth && 
                   paymentDate.getFullYear() === currentYear &&
                   p.status === 'Pagado';
        })
        .reduce((sum, p) => sum + (p.amount * (1 - p.discount / 100)), 0);
    
    // Actualizar los valores en el dashboard
    document.getElementById('active-clients-count').textContent = activeClients;
    document.getElementById('today-attendance-count').textContent = todayAttendance;
    document.getElementById('trainers-count').textContent = trainersCount;
    document.getElementById('monthly-income').textContent = `$${monthlyIncome.toFixed(2)}`;
}
// Agregar despu√©s de las funciones existentes
function searchClients() {
    const searchText = document.getElementById('search-client').value.toLowerCase();
    const searchCedula = document.getElementById('search-client-cedula').value.trim();
    const tableBody = document.getElementById('clients-table');
    const data = getGymData();
    
    // Filtrar clientes
    const filteredClients = data.clients.filter(client => {
        const matchesText = searchText === '' || 
            client.name.toLowerCase().includes(searchText) ||
            client.email.toLowerCase().includes(searchText) ||
            client.phone.toLowerCase().includes(searchText);
            
        const matchesCedula = searchCedula === '' || 
            client.cedula.toString().includes(searchCedula);
            
        return matchesText && matchesCedula;
    });
    
    // Limpiar tabla
    tableBody.innerHTML = '';
    
    // Mostrar resultados
    filteredClients.forEach(client => {
        const membership = getMembershipById(client.membership_id);
        const isActive = isMembershipActive(client.start_date, membership.duration);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${client.cedula}</td>
            <td>${client.name}</td>
            <td>${client.email}</td>
            <td>${client.phone}</td>
            <td>${membership.name}</td>
            <td>
                <span class="badge ${isActive ? 'badge-success' : 'badge-danger'}">
                    ${isActive ? 'Activo' : 'Inactivo'}
                </span>
            </td>
            <td>
                <button class="btn btn-primary" onclick="viewClient('${client.cedula}')">Ver</button>
                <button class="btn btn-warning" onclick="editClient('${client.cedula}')">Editar</button>
                <button class="btn btn-danger" onclick="deleteClient('${client.cedula}')">Eliminar</button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Agregar event listeners para los campos de b√∫squeda
document.getElementById('search-client').addEventListener('input', searchClients);
document.getElementById('search-client-cedula').addEventListener('input', searchClients);

// Agregar validaci√≥n para el campo de c√©dula
document.getElementById('search-client-cedula').addEventListener('input', function(e) {
    // Eliminar caracteres no num√©ricos
    this.value = this.value.replace(/[^0-9]/g, '');
    
    // Limitar a 11 caracteres
    if (this.value.length > 11) {
        this.value = this.value.slice(0, 11);
    }
});

document.getElementById('client-phone').addEventListener('input', function(e) {
    // Remove any non-numeric characters
    this.value = this.value.replace(/[^0-9]/g, '');
    
    // Limit to 10 digits
    if (this.value.length > 10) {
        this.value = this.value.slice(0, 10);
    }
});

    </script>
</body>
